import java.util.ArrayList;
import java.util.HashMap;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

public class ConcreteOrderFactory extends OrderFactory{
	
	private JSONParser jparser;
	private ControllerLocator locator;
	
	public ConcreteOrderFactory(){
		
		this.jparser = new JSONParser();
		this.locator = new ControllerLocator();
	}

	@Override
	public Order createOrder(String order) throws ParseException {
		
		JSONModule jmodule = new JSONModule();
		jmodule.parseOrder(order);
		
		this.locator.locateMachine(jmodule.getCondiments() != null, 
								   jmodule.getDrink(), 
								   jmodule.getStreet(), 
								   jmodule.getZip());
		
		ArrayList<String> recipe = this.locator.getRecipe();
		String machineID         = this.locator.getMachine();
		String controllerID      = this.locator.getController();
		MachineType type         = this.locator.getType();
		
		Coffee coffee = createCoffee(jmodule.getDrink(), jmodule.getCondiments(), recipe);
		
		switch(type){
		
			case SIMPLE:
				return new SimpleOrder(jmodule.getOrderID(), coffee, controllerID, machineID);
			case AUTOMATED: 
				return new AutomatedOrder(jmodule.getOrderID(), coffee, controllerID, machineID);
			case PROGRAMMABLE: 
				return new ProgrammableOrder(jmodule.getOrderID(), coffee, controllerID, machineID);
		}
		
		return null;
	}
	
	private Coffee createCoffee(String drink, HashMap<String, Integer> condiments, ArrayList<String> recipe){
		
		Coffee coffee = new BaseCoffee(drink, recipe);
		
		for (String condiment : condiments.keySet()){
			
			for (int i = 0; i < condiments.get(condiment); i++){
			
				coffee = new CondimentDecorator(condiment, coffee);
			}
		}
		
		return coffee;
	}
}
